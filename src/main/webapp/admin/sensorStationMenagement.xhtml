<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3c.org/1999/xhtml"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:p="http://primefaces.org/ui"
                template="/WEB-INF/templates/main.xhtml">
    <!-- ........THIS PAGE SHOWS THE LIST OF GREENHOUSES ; IF THE BUTTON IS PRESSED ON A GREENHOUSE THEN THE GREENHOUSEDETAILSPAGE............... -->
    <!-- ........OF THE SENSOR STATION(GREENHOUSE) OF THE CORRESPONDING GREENHOUSE IS OPENED::::::::::::::::::::::::::::::::............... -->


    <ui:define name="title">Dashboard</ui:define>
    <ui:define name="head">
        <link rel="stylesheet" href="/webjars/font-awesome/6.4.0/css/all.min.css" />
    </ui:define>


    <ui:define name ="content">



        <!-- ...................................PLANT CREATE dialog.................................... -->
        <h:form id="plantCreateDialog">
            <!-- ....................PLANT CREATE button..................... -->
            <p:commandButton style="margin-bottom: 10px; margin-left: 7px" value="Create new Plant" update=":plantCreateDialog:createPlantDialog" oncomplete="PF('createPlantDialog').show()"
                             icon="pi pi-user-plus" title="New User" class="btn btn-primary">
                <p:resetInput target="createPlantDialog"/>
            </p:commandButton>
            <p:dialog header="Create New Plant" id="createPlantDialog" widgetVar="createPlantDialog" modal="true"
                      showEffect="fade" hideEffect="fade" resizable="false">
                <p:ajax event="close" update="createPlantDialog"/>
                <p:outputPanel id="createPlant">
                    <h:panelGrid columns="2">
                        <p:outputLabel for="plantNameCreation" value="Plant Name:"/>
                        <p:inputText id="plantNameCreation"
                                     placeholder="Required field" value="#{createPlantBean.plantName}" required="true"/>
                        <p:outputLabel for="plantDescrptiom" value="Description:"/>
                        <p:inputText id="plantDescrptiom"
                                     placeholder="description" value="#{createPlantBean.description}" required="false"/>
                        <p:commandButton value="Create"
                                         action="#{createPlantBean.doCreateNewPlant()}"
                                         update=":userForm:sensorStationTable"
                                         oncomplete="PF('createPlantDialog').hide()"/>
                        <p:commandButton value="Cancel" onclick="PF('createPlantDialog').hide()"/>
                    </h:panelGrid>
                </p:outputPanel>
            </p:dialog>
        </h:form>





        <!-- ...................................Sensor station CREATE dialog Form.................................... -->
        <h:form id="createDialog">
            <!-- ....................Sensor station CREATE button..................... -->
            <p:commandButton  style="margin-left: 7px" value="Create new Sensor Station" update=":createDialog:createSSDialog" oncomplete="PF('createSSDialog').show()"
                             icon="pi pi-user-plus" title="New Sensor Station" class="btn btn-primary">
                <p:resetInput target=":createDialog:createSSDialog"/>
            </p:commandButton>
            <!-- ....................Create sensor station dialog.................................................... -->
            <p:dialog header="Create New Sensor Station" id="createSSDialog" widgetVar="createSSDialog" modal="true"
                      showEffect="fade" hideEffect="fade" resizable="false">
                <p:ajax event="close" update="createSSDialog"/>
                <p:outputPanel id="createSS">
                    <h:panelGrid columns="2">
                        <p:outputLabel for="usernameCreation" value="Sensor Station Name:"/>
                        <p:inputText id="usernameCreation"
                                     placeholder="Required field" value="#{createSensorStationBean.sensorStationName}" required="true"/>
                        <p:outputLabel for="description" value="Description:"/>
                        <p:inputText id="description"
                                     placeholder="description" value="#{createSensorStationBean.description}" required="false"/>
                        <p:outputLabel for="location" value="Location:"/>
                        <p:inputText id="location" value="#{createSensorStationBean.location}"/>
                        <p:outputLabel for="sensorStationswitch" value="Alarm Switch:"/>
                        <p:selectOneMenu id="sensorStationswitch" value="#{createSensorStationBean.alarmSwitch}"  >
                            <f:selectItem itemLabel="On" itemValue="On"/>
                            <f:selectItem itemLabel="Off" itemValue="Off"/>
                        </p:selectOneMenu>
                        <!-- ................Create Sensor Station Button....................... -->
                        <p:commandButton value="Create"
                                         action="#{createSensorStationBean.doCreateNewCreateSensorStation()}"
                                         update=":userForm:sensorStationTable"
                                         oncomplete="PF('createSSDialog').hide(); location.reload()"/>
                        <p:commandButton value="Cancel" onclick="PF('createSSDialog').hide()"/>
                    </h:panelGrid>
                </p:outputPanel>
            </p:dialog>

        </h:form>













        <!-- .........................................TABLE.............................................................. -->
        <h:form id="userForm">
            <div class="col-12">

                <div class="card">
                    <h5>Sensor Stations</h5>
                    <p:dataTable id="sensorStationTable" var="sensorStation" value="#{sensorStationListController.sensorStationList}"
                                 scrollHeight="550"
                                 paginatorPosition="bottom" rowKey="#{sensorStation.id}">

                        <p:ajax event="rowToggle" listener="#{sensorStationDetailController.onRowToggle}" />

                        <p:column >
                            <p:rowToggler/>
                        </p:column>

                        <p:column  headerText="Id" sortBy="#{sensorStation.id}">
                            <h:outputText value="#{sensorStation.id}"/>
                        </p:column>

                        <p:column  headerText="Access Point" sortBy="#{sensorStation.accessPoint}">
                            <h:outputText value="#{sensorStation.accessPoint}"/>
                        </p:column>

                        <p:column  headerText="Plant" sortBy="#{sensorStation.plant.plantName}">
                            <h:outputText value="#{sensorStation.plant}"/>
                        </p:column>

                        <p:column  headerText="Gardeners">
                            <h:outputText value="#{sensorStation.gardener}"/>
                        </p:column>

                        <p:column headerText="Alarm Status">
                            <i class="#{measurementListController.getMeasurementTypeIcon('AIR_PRESSURE')}"
                               style="color:#{measurementListController.getSensorStatus('AIR_PRESSURE',sensorStation) == 'OK' ? 'green' : 'red'}"
                               title="Air Pressure"></i>
                            <i class="#{measurementListController.getMeasurementTypeIcon('TEMPERATURE')}"
                               style="color:#{measurementListController.getSensorStatus('TEMPERATURE',sensorStation) == 'OK' ? 'green' : 'red'}"
                               title="Temperature"></i>
                            <i class="#{measurementListController.getMeasurementTypeIcon('SOIL_MOISTURE')}"
                               style="color:#{measurementListController.getSensorStatus('SOIL_MOISTURE',sensorStation) == 'OK' ? 'green' : 'red'}"
                               title="Soil Moisture"></i>
                            <i class="#{measurementListController.getMeasurementTypeIcon('AIR_QUALITY')}"
                               style="color:#{measurementListController.getSensorStatus('AIR_QUALITY',sensorStation) == 'OK' ? 'green' : 'red'}"
                               title="Air Quality"></i>
                            <i class="#{measurementListController.getMeasurementTypeIcon('LIGHT_INTENSITY')}"
                               style="color:#{measurementListController.getSensorStatus('LIGHT_INTENSITY',sensorStation) == 'OK' ? 'green' : 'red'}"
                               title="Light Intensity"></i>
                            <i class="#{measurementListController.getMeasurementTypeIcon('HUMIDITY')}"
                               style="color:#{measurementListController.getSensorStatus('HUMIDITY',sensorStation) == 'OK' ? 'green' : 'red'}"
                               title="Humidity"></i>
                        </p:column>

                        <p:column  headerText="Location" sortBy="#{sensorStation.location}">
                            <h:outputText value="#{sensorStation.location}"/>
                        </p:column>

                        <p:column  headerText="Alarm switch" sortBy="#{sensorStation.alarmSwitch}">
                            <h:outputText value="#{sensorStation.alarmSwitch}"/>
                        </p:column>


                        <p:column style="text-align: center">

                            <!-- DetailView page Button -->
                            <p:button icon="pi pi-search"
                                             title="open Detail-View"
                                             href="/greenHouseDetails.xhtml?id=#{sensorStation.id}" />

                            <!-- ....................SENSOR STATION pairing BUTTON ........... .............. -->
                            <p:commandButton  update=":userForm:pairingDialog"
                                              oncomplete="PF('pairingDialog').show()" icon="pi pi-sync" title="Pair">
                                <f:setPropertyActionListener value="#{sensorStation.id}" target="#{pairingController.sensorStationId}"/>
                            </p:commandButton>

                            <!-- ....................SENSOR STATION EDIT BUTTON ........... .............. -->
                            <p:commandButton  update=":userForm:userEditDialog"
                                             oncomplete="PF('userEditDialog').show()" icon="pi pi-user-edit" title="Edit">
                                <f:setPropertyActionListener value="#{sensorStation}" target="#{sensorStationDetailController.sensorStation}"/>
                            </p:commandButton>

                            <!-- ....................DELETE SENSOR STATION BUTTON ........... .............. -->
                            <p:commandButton styleClass="ui-button-danger"
                                             action="#{sensorStationDetailController.doDeleteSensorStation()}" icon="pi pi-user-minus"
                                             title="Delete"
                                             update=":userForm:sensorStationTable"
                                            oncomplete="location.reload()">
                                <f:setPropertyActionListener value="#{sensorStation}" target="#{sensorStationDetailController.sensorStation}"/>
                                <p:confirm header="Confirmation"
                                           message="Are you sure that you want to delete the sensor station '#{sensorStation.sensorStationName}'? You cannot undo this operation."
                                           icon="pi pi-exclamation-triangle"/>
                            </p:commandButton>

                        </p:column>

                        <!-- .........................................ROW EXPANSION.......................................................... -->
                        <p:rowExpansion>
                            <div class="orders-subtable">
                                <h5>Latest Measurements for Greenhouse #{sensorStation.id}</h5>
                                <p:dataTable var="measurement" value="#{sensorStationDetailController.latestMeasurements}" reflow="true" rowKey="#{measurement.id}">
                                    <p:column headerText="Type" sortBy="#{measurement.type}">
                                        <h:outputText value="#{measurement.type}" />
                                    </p:column>

                                    <p:column headerText="Value" sortBy="#{measurement.value_s}">
                                        <h:outputText value="#{measurement.value_s}" />
                                    </p:column>

                                    <p:column headerText="Unit" sortBy="#{measurement.unit}">
                                        <h:outputText value="#{measurement.unit}">
                                            <f:convertNumber currencySymbol="$" type="currency" />
                                        </h:outputText>
                                    </p:column>

                                    <p:column headerText="Sensor Alarm Status">
                                        <h:form rendered="#{not empty measurement.id}">
                                        <i class="#{measurementListController.getMeasurementTypeIcon(measurement.type)}"
                                           style="display: flex; justify-content: center; align-items: center; color:#{measurementListController.getSensorStatus(measurement.type,sensorStation) == 'OK' ? 'green' : 'red'}"
                                           title="#{measurement.type}"></i>
                                        </h:form>
                                    </p:column>

                                </p:dataTable>
                            </div>
                        </p:rowExpansion>

                    </p:dataTable>
                </div>
            </div>












            <!-- .......................................DIALOGS...................................................................... -->



            <!-- ...................................PAIR WITH Access point..DIALOG.................................. -->
            <p:dialog header="Pairing" id="pairingDialog" widgetVar="pairingDialog" modal="true"
                      showEffect="fade" hideEffect="fade" resizable="false">
                <p:outputPanel id="userData2" >
                    <h:panelGrid columns="1">

                        <p:outputLabel for="pairedWith" value="Paired With:"/>
                        <p:inputText rendered="#{not empty pairingController.sensorStationAccessPointId}" id="pairedWith" value="#{pairingController.sensorStationAccessPointId}" disabled="true" />
                        <p:outputLabel for="sensorStationAccessPoint" value="Pair to new Access Point:"/>
                        <p:selectOneMenu value="#{pairingController.accessPointId}" id="sensorStationAccessPoint" filter="true" emptyLabel="Access Point ID"
                                         scrollHeight="250" updateLabel="true" >
                            <f:selectItems value="#{pairingController.accessPointsIds}"/>
                            <f:facet name="footer">
                                <p:divider styleClass="mt-0" />
                                <h:outputText value="3 options" style="font-weight:bold;"/>
                            </f:facet>
                        </p:selectOneMenu>
                        <!-- ...................................PAIR/UNPAIR BUTTONS .................................... -->
                        <h:panelGrid columns="3">
                        <p:commandButton value="Remove current pairing" action="#{pairingController.unpair()}"
                                         oncomplete="PF('pairingDialog').hide();location.reload()" update=":userForm:sensorStationTable">
                        <p:confirm header="Confirmation"
                                   message="Are you sure that you want to unpair the sensor station?"
                                   icon="pi pi-exclamation-triangle"/>
                        </p:commandButton>
                        </h:panelGrid>

                        <h:panelGrid columns="2">

                            <p:commandButton id="startBatch" value="Pair" actionListener="#{pairingController.pair}" update=":userForm:sensorStationTable"
                                                oncomplete="location.reload()"/>

                            <p:commandButton id="abortbutton"  async="true" value="Abort Pairing" actionListener="#{pairingController.abortPairing()}" update=":userForm:sensorStationTable"  />
                            <p:ajax event="click" listener="#{pairingController.abortPairing()}" oncomplete="PF('pairingDialog').hide()" />

                        </h:panelGrid>

                    </h:panelGrid>

                </p:outputPanel>
            </p:dialog>

            <!-- ...................................CONFIRMATION DIALOG .................................... -->
            <p:confirmDialog global="true" showEffect="fade" hideEffect="fade" width="300">
                <p:commandButton value="Yes" type="button" styleClass="ui-confirmdialog-yes" icon="pi pi-check"/>
                <p:commandButton value="No" type="button" styleClass="ui-confirmdialog-no" icon="pi pi-times"/>
            </p:confirmDialog>















            <!-- ...................................Sensor station Edit dialog.................................... -->
            <p:dialog header="Edit Sensor Staion" id="userEditDialog" widgetVar="userEditDialog" modal="true"
                      showEffect="fade" hideEffect="fade" resizable="false">
                <p:outputPanel id="userData" rendered="#{not empty sensorStationDetailController.sensorStation}">
                    <h5 class="mt-0">Sensor Station Data </h5>
                    <h:panelGrid columns="1">

                        <p:outputLabel for="sensorStationId" value="Sensor-station name:"/>
                        <p:inputText id="sensorStationId" value="#{sensorStationDetailController.sensorStation.sensorStationName}" disabled="true" />


                        <p:outputLabel for="sensorStationlocation" value="Sensor-station location:"/>
                        <p:inputText id="sensorStationlocation" rendered="#{not empty sensorStationDetailController.sensorStation}" value="#{sensorStationDetailController.sensorStation.location}"/>

                        <p:outputLabel for="sensorStationswitchEdit" value="Alarm Switch:"/>
                        <p:selectOneMenu id="sensorStationswitchEdit" value="#{sensorStationDetailController.sensorStation.alarmSwitch}"  >
                            <f:selectItem itemLabel="Fixed" itemValue="fixed"/>
                            <f:selectItem itemLabel="Off" itemValue="Off"/>
                        </p:selectOneMenu>

                        <!-- ...................................GARDENER ADD AND REMOVE.................................... -->
                        <p:outputLabel for="AddGardenre" value="Add Gardeners:"/>
                        <p:selectCheckboxMenu id="AddGardenre" value="#{sensorStationDetailController.gardeners}" label="Gardeners" style="min-width: 15rem"
                                              multiple="true" filter="true" filterMatchMode="startsWith" panelStyle="width: 30rem" scrollHeight="250"
                                              emptyLabel="Select Gardener..." updateLabel="true">
                            <f:selectItems value="#{userListController.gardenerNames}"/>
                        </p:selectCheckboxMenu>

                        <p:outputLabel for="RemoveGardener" value="Remove Gardeners:"/>
                        <p:selectCheckboxMenu id="RemoveGardener" value="#{sensorStationDetailController.gardenersToRemove}" label="Gardeners" style="min-width: 15rem"
                                              multiple="true" filter="true" filterMatchMode="startsWith" panelStyle="width: 30rem" scrollHeight="250"
                                              emptyLabel="Select Gardener..." updateLabel="true">
                            <f:selectItems value="#{sensorStationDetailController.sensorStation.gardener}"/>
                        </p:selectCheckboxMenu>


                    </h:panelGrid>
                    <h:panelGrid columns="3">
                        <p:commandButton value="Save" action="#{sensorStationDetailController.doSaveSensorStation()}"
                                         oncomplete="PF('userEditDialog').hide();location.reload()" update=":userForm:sensorStationTable"/>
                        <p:commandButton value="Abort" onclick="PF('userEditDialog').hide()"/>


                    </h:panelGrid>
                </p:outputPanel>
            </p:dialog>


        </h:form>














    </ui:define>
</ui:composition>
