<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3c.org/1999/xhtml"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:p="http://primefaces.org/ui"
                template="/WEB-INF/templates/main.xhtml">
    <!-- ........THIS PAGE SHOWS THE LIST OF GREENHOUSES ; IF THE BUTTON IS PRESSED ON A GREENHOUSE THEN THE GREENHOUSEDETAILSPAGE............... -->
    <!-- ........OF THE SENSOR STATION(GREENHOUSE) OF THE CORRESPONDING GREENHOUSE IS OPENED::::::::::::::::::::::::::::::::............... -->


    <ui:define name="title">Dashboard</ui:define>
    <ui:define name="head">
        <link rel="stylesheet" href="/webjars/font-awesome/6.4.0/css/all.min.css" />
    </ui:define>



    <ui:define name ="content">

        <!-- ...................................PLANT CREATE dialog.................................... -->
        <h:form id="plantCreateDialog">


            <p:dialog header="Create New Plant" id="createPlantDialog" widgetVar="createPlantDialog" modal="true"
                      showEffect="fade" hideEffect="fade" resizable="false">
                <p:ajax event="close" update="createPlantDialog"/>

                <p:outputPanel id="createPlant">
                    <h:panelGrid columns="2">


                        <p:outputLabel for="plantNameCreation" value="Plant Name:"/>
                        <p:inputText id="plantNameCreation"
                                     placeholder="Required field" value="#{createPlantBean.plantName}" required="true"/>


                        <p:outputLabel for="plantDescrptiom" value="Description:"/>
                        <p:inputText id="plantDescrptiom"
                                     placeholder="description" value="#{createPlantBean.description}" required="false"/>


                        <p:commandButton value="Create"
                                         action="#{createPlantBean.doCreateNewPlant()}"
                                         update=":userForm:sensorStationTable"
                                         oncomplete="PF('createPlantDialog').hide()"/>
                        <p:commandButton value="Cancel" onclick="PF('createPlantDialog').hide()"/>






                    </h:panelGrid>

                </p:outputPanel>
            </p:dialog>
        </h:form>


        <!-- .........................................TABLE.............................................................. -->
        <h:form id="userForm">
            <div class="col-12">

                <div class="card">
                    <h5>Assigned Greenhouses</h5>
                    <p:dataTable id="sensorStationTable" var="sensorStation" value="#{sensorStationListController.assignedSensorStationList}"
                                  scrollHeight="550"
                                 paginatorPosition="bottom" rowKey="#{sensorStation.id}">

                        <p:ajax event="rowToggle" listener="#{sensorStationDetailController.onRowToggle}" />

                        <p:column style="width:2rem">
                            <p:rowToggler/>
                        </p:column>

                        <p:column headerText="Id" sortBy="#{sensorStation.id}" filterBy="#{sensorStation.id}">
                            <h:outputText value="#{sensorStation.id}"/>
                        </p:column>

                        <p:column >
                            <p:graphicImage url="../resources/images/plant1.jpg" styleClass="shadow-2" width="100"/>
                        </p:column>

                        <p:column headerText="Plant" sortBy="#{sensorStation.plant.plantName}" filterBy="#{sensorStation.plant.plantName}">
                            <h:outputText value="#{sensorStation.plant}"/>
                        </p:column>

                        <p:column style="" headerText="Intervals">
                            <h:outputText value="W:#{SSIntervalController.getActualWebAppIntervalForSensorStation(sensorStation)}  "/>
                            <h:outputText value=" M:#{SSIntervalController.getActualMeasurementIntervalForSensorStation(sensorStation)} "/>
                        </p:column>

                        <p:column headerText="Alarm Status">
                            <i class="#{measurementListController.getMeasurementTypeIcon('AIR_PRESSURE')}"
                               style="color:#{measurementListController.getSensorStatus('AIR_PRESSURE',sensorStation) == 'OK' ? 'green' : 'red'}"
                               title="Air Pressure"></i>
                            <i class="#{measurementListController.getMeasurementTypeIcon('TEMPERATURE')}"
                               style="color:#{measurementListController.getSensorStatus('TEMPERATURE',sensorStation) == 'OK' ? 'green' : 'red'}"
                               title="Temperature"></i>
                            <i class="#{measurementListController.getMeasurementTypeIcon('SOIL_MOISTURE')}"
                               style="color:#{measurementListController.getSensorStatus('SOIL_MOISTURE',sensorStation) == 'OK' ? 'green' : 'red'}"
                               title="Soil Moisture"></i>
                            <i class="#{measurementListController.getMeasurementTypeIcon('AIR_QUALITY')}"
                               style="color:#{measurementListController.getSensorStatus('AIR_QUALITY',sensorStation) == 'OK' ? 'green' : 'red'}"
                               title="Air Quality"></i>
                            <i class="#{measurementListController.getMeasurementTypeIcon('LIGHT_INTENSITY')}"
                               style="color:#{measurementListController.getSensorStatus('LIGHT_INTENSITY',sensorStation) == 'OK' ? 'green' : 'red'}"
                               title="Light Intensity"></i>
                            <i class="#{measurementListController.getMeasurementTypeIcon('HUMIDITY')}"
                               style="color:#{measurementListController.getSensorStatus('HUMIDITY',sensorStation) == 'OK' ? 'green' : 'red'}"
                               title="Humidity"></i>
                        </p:column>

                        <p:column headerText="Location" sortBy="#{sensorStation.location}" filterBy="#{sensorStation.location}">
                            <h:outputText value="#{sensorStation.location}"/>
                        </p:column>

                        <p:column headerText="Alarm switch" sortBy="#{sensorStation.alarmSwitch}" filterBy="#{sensorStation.alarmSwitch}">
                            <h:outputText value="#{sensorStation.alarmSwitch}"/>
                        </p:column>


                        <p:column style="text-align: center">


                            <!-- ...........BUTTON TO OPEN QR CODE GENERATION PAGE......... -->
                            <p:button style="margin-right: 2px" icon="pi pi-qrcode" disabled="#{sensorStation.plant == null}"
                                      title="Generate QR-Code"
                                      href="/generateQrCode.xhtml?id=#{sensorStation.plant.plantID}">
                            </p:button>

                            <!-- DetailView page Button -->
                            <p:button style="margin-right: 2px"
                                      icon="pi pi-search"
                                      title="open Detail-View"
                                      href="/greenHouseDetails.xhtml?id=#{sensorStation.id}" />

                            <!-- ....................SENSOR STATION EDIT BUTTON ........... .............. -->
                            <p:commandButton style="margin-right: 2px"  update=":userForm:userEditDialog"
                                             oncomplete="PF('userEditDialog').show()" icon="pi pi-user-edit" title="Edit">
                                <f:setPropertyActionListener value="#{sensorStation}" target="#{sensorStationDetailController.sensorStation}"/>
                            </p:commandButton>

                            <!-- .................... INTERVALS BUTTON ........... .............. -->
                            <p:commandButton style="margin-right: 2px; background-color: orange" update=":userForm:intervalEditDialog"
                                             oncomplete="PF('intervalEditDialog').show()" icon="fa fa-solid fa-sliders" title="Intervals">
                                <f:setPropertyActionListener value="#{sensorStation.accessPoint.id}" target="#{SSIntervalController.accessPointId}"/>
                            </p:commandButton>






                        </p:column>



                        <!-- .........................................ROW EXPANSION.......................................................... -->
                        <p:rowExpansion>
                            <div class="orders-subtable">
                                <h5>Latest Measurements for Greenhouse #{sensorStation.id}</h5>
                                <p:dataTable var="measurement" value="#{sensorStationDetailController.latestMeasurements}" reflow="true" rowKey="#{measurement.id}">
                                    <p:column headerText="Type" sortBy="#{measurement.type}">
                                        <h:outputText value="#{measurement.type}" />
                                    </p:column>

                                    <p:column headerText="Value" sortBy="#{measurement.value_s}">
                                        <h:outputText value="#{measurement.value_s}" />
                                    </p:column>

                                    <p:column headerText="Unit" sortBy="#{measurement.unit}">
                                        <h:outputText value="#{measurement.unit}">
                                            <f:convertNumber currencySymbol="$" type="currency" />
                                        </h:outputText>
                                    </p:column>

                                    <p:column headerText="Status">
                                        <i class="#{measurementListController.getMeasurementTypeIcon(measurement.type)}"
                                           style="display: flex; justify-content: center; align-items: center; color:#{measurementListController.getSensorStatus(measurement.type,sensorStation) == 'OK' ? 'green' : 'red'}"
                                           title="#{measurement.type}"></i>
                                    </p:column>

                                </p:dataTable>
                            </div>
                        </p:rowExpansion>

                    </p:dataTable>
                </div>
            </div>








            <!-- .......................................DIALOGS...................................................................... -->

            <!-- ...................................Interval Edit dialog.................................... -->
            <p:dialog header="Edit Access Point Intervals" id="intervalEditDialog" widgetVar="intervalEditDialog" modal="true"
                      showEffect="fade" hideEffect="fade" resizable="false">
                <p:outputPanel id="intervalData">
                    <h:panelGrid columns="1">

                        <p:outputLabel for="mInterval" value="New Interval Webapp: (minutes):"/>
                        <p:inputText id="mInterval" value="#{SSIntervalController.webAppInterval}" />
                        <p:outputLabel for="sinterval" value="New Interval Measurements: (minutes)"/>
                        <p:inputText id="sinterval"  value="#{SSIntervalController.measurementInterval}"/>

                    </h:panelGrid>
                    <h:panelGrid columns="3">
                        <p:commandButton value="Save New Intervals" action="#{SSIntervalController.doSaveInterval()}"
                                         oncomplete="PF('intervalEditDialog').hide();location.reload()" update="sensorStationTable"/>
                        <p:commandButton value="Abort" onclick="PF('intervalEditDialog').hide()"/>

                    </h:panelGrid>
                </p:outputPanel>
            </p:dialog>






            <!-- ...................................Sensor station Edit dialog.................................... -->
            <p:dialog header="Edit Sensor Station" id="userEditDialog" widgetVar="userEditDialog" modal="true"
                      showEffect="fade" hideEffect="fade" resizable="false">
                <p:outputPanel id="userData" rendered="#{not empty sensorStationDetailController.sensorStation}">
                    <h:panelGrid columns="1">

                        <p:outputLabel for="sensorStationId" value="Sensor-station name:"/>
                        <p:inputText id="sensorStationId" value="#{sensorStationDetailController.sensorStation.sensorStationName}" disabled="true" />

                        <p:outputLabel for="sensorStationAccessPoint" value="Access Point:"/>
                        <p:selectOneMenu id="sensorStationAccessPoint" filter="true" emptyLabel="Access Point ID" disabled="true"
                                         scrollHeight="250" updateLabel="true" >
                            <f:selectItems value="#{accessPointController.accessPoints}"/>
                            <f:facet name="footer">
                                <p:divider styleClass="mt-0" />
                                <h:outputText value="3 options" style="font-weight:bold;"/>
                            </f:facet>
                        </p:selectOneMenu>


                        <p:outputLabel for="sensorStationlocation" value="Sensor-station location:"/>
                        <p:inputText id="sensorStationlocation" rendered="#{not empty sensorStationDetailController.sensorStation}" value="#{sensorStationDetailController.sensorStation.location}"/>



                        <p:outputLabel for="sensorStationswitchEdit1" value="Alarm Switch to Fixed(if not):" />
                        <p:toggleSwitch id ="sensorStationswitchEdit1" rendered="#{sensorStationDetailController.sensorStation.alarmSwitch.equals('fixed') == false}" value="#{sensorStationDetailController.sensorStation.alarmSwitch}"/>

                    </h:panelGrid>
                    <h:panelGrid columns="3">
                        <p:commandButton value="Save" action="#{sensorStationDetailController.doSaveSensorStation()}"
                                         oncomplete="PF('userEditDialog').hide()" update=":userForm:sensorStationTable sensorStationswitchEdit1"/>
                        <p:commandButton value="Abort" onclick="PF('userEditDialog').hide()"/>
                    </h:panelGrid>
                </p:outputPanel>
            </p:dialog>


            <!-- ...................................CONFIRMATION dialog.................................... -->
            <p:confirmDialog global="true" showEffect="fade" hideEffect="fade" width="300">
                <p:commandButton value="Yes" type="button" styleClass="ui-confirmdialog-yes" icon="pi pi-check"/>
                <p:commandButton value="No" type="button" styleClass="ui-confirmdialog-no" icon="pi pi-times"/>
            </p:confirmDialog>

        </h:form>











    </ui:define>
</ui:composition>
